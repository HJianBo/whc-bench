name: Build wrk Offline Installer for EL8 (CentOS/Rocky 8)

on:
  # æ‰‹åŠ¨è§¦å‘ workflowï¼Œæ–¹ä¾¿æ„å»ºç¦»çº¿åŒ…
  workflow_dispatch: {}
  # æˆ–è€…åœ¨æ¯æ¬¡æ–°çš„ Tag å‘å¸ƒæ—¶è§¦å‘
  # push:
  #   tags:
  #     - 'v*'

jobs:
  build_offline_package:
    # ä½¿ç”¨é€šç”¨çš„ Ubuntu runner å¹¶é€šè¿‡ Docker å®¹å™¨æ¥æ¨¡æ‹Ÿ CentOS 8 ç¯å¢ƒ
    runs-on: ubuntu-latest

    container:
      # ä½¿ç”¨ CentOS 8 çš„ç¨³å®šæ›¿ä»£å“ Rocky Linux 8 ä½œä¸ºæ„å»ºç¯å¢ƒ
      image: rockylinux:8
      options: --user root # ç¡®ä¿æœ‰ root æƒé™æ‰§è¡Œå®‰è£…å’Œæ‰“åŒ…æ“ä½œ

    steps:
    - name: â¬‡ï¸ Checkout repository (If needed, for versioning/context)
      # å¦‚æœä½ çš„é¡¹ç›®éœ€è¦ä¸Šä¸‹æ–‡ï¼Œå°±ä¿ç•™è¿™ä¸€æ­¥
      uses: actions/checkout@v4

    - name: ğŸ”„ Install EPEL Repository and Utilities
      shell: bash
      run: |
        # å®‰è£… EPEL ä»“åº“é…ç½®åŒ…
        dnf install -y epel-release 
        # å®‰è£… tar å’Œ gzip å·¥å…·ï¼Œç”¨äºåç»­æ‰“åŒ…
        dnf install -y tar gzip

    - name: ğŸ“¦ Download wrk and its Dependencies
      shell: bash
      run: |
        echo "Starting download of wrk and all dependencies for offline installation..."
        # ä½¿ç”¨ dnf download --resolve ä¸‹è½½ wrk åŠå…¶æ‰€æœ‰ä¾èµ–åˆ°å½“å‰ç›®å½•
        dnf download --resolve wrk
        
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "ERROR: Failed to download wrk or its dependencies."
          exit 1
        fi
        
        # åˆ›å»ºä¸€ä¸ªç›®å½•æ¥å­˜æ”¾RPMæ–‡ä»¶ï¼Œæ–¹ä¾¿åç»­æ‰“åŒ…
        mkdir wrk_offline_el8
        mv *.rpm wrk_offline_el8/
        
        echo "Downloaded files:"
        ls -l wrk_offline_el8/

    - name: ğŸ¯ Create Offline Installation Archive
      shell: bash
      run: |
        ARCHIVE_NAME="wrk-4.2.0-el8-offline-$(date +%Y%m%d).tar.gz"
        
        # åˆ‡æ¢åˆ°çˆ¶ç›®å½•æ‰“åŒ…
        tar -czvf ${ARCHIVE_NAME} wrk_offline_el8
        
        echo "::set-output name=archive_name::${ARCHIVE_NAME}"
      id: archive

    - name: â¬†ï¸ Upload Offline Package as Artifact
      uses: actions/upload-artifact@v4
      with:
        # ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ¡£æ¡ˆåç§°
        name: ${{ steps.archive.outputs.archive_name }}
        path: ${{ steps.archive.outputs.archive_name }}
        retention-days: 7 # äº§ç‰©ä¿ç•™ 7 å¤©
        
    - name: ğŸ‰ Print Success Message
      run: |
        echo "--------------------------------------------------------"
        echo "ç¦»çº¿å®‰è£…åŒ…å·²æˆåŠŸæ„å»ºå¹¶ä¸Šä¼ ä¸º Artifactï¼š"
        echo "${{ steps.archive.outputs.archive_name }}"
        echo "æ‚¨å¯ä»¥åœ¨ Actions é¡µé¢ä¸‹è½½æ­¤æ–‡ä»¶ï¼Œå¹¶åœ¨ç¦»çº¿ç¯å¢ƒä¸­ä½¿ç”¨ 'sudo dnf install *.rpm' è¿›è¡Œå®‰è£…ã€‚"
        echo "--------------------------------------------------------"