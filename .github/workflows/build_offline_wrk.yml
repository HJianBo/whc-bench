name: Build wrk Offline Installer for EL8 (CentOS/Rocky 8)

on:
  # æ‰‹åŠ¨è§¦å‘ workflowï¼Œæ–¹ä¾¿æž„å»ºç¦»çº¿åŒ…
  workflow_dispatch: {}
  # æˆ–è€…åœ¨æ¯æ¬¡æ–°çš„ Tag å‘å¸ƒæ—¶è§¦å‘
  # push:
  #   tags:
  #     - 'v*'

jobs:
  build_offline_package:
    # ä½¿ç”¨é€šç”¨çš„ Ubuntu runner å¹¶é€šè¿‡ Docker å®¹å™¨æ¥æ¨¡æ‹Ÿ CentOS 8 çŽ¯å¢ƒ
    runs-on: ubuntu-latest

    container:
      # ä½¿ç”¨ CentOS 8 çš„ç¨³å®šæ›¿ä»£å“ Rocky Linux 8 ä½œä¸ºæž„å»ºçŽ¯å¢ƒ
      image: rockylinux:8
      options: --user root # ç¡®ä¿æœ‰ root æƒé™æ‰§è¡Œå®‰è£…å’Œæ‰“åŒ…æ“ä½œ

    steps:
    - name: â¬‡ï¸ Checkout repository (If needed, for versioning/context)
      # å¦‚æžœä½ çš„é¡¹ç›®éœ€è¦ä¸Šä¸‹æ–‡ï¼Œå°±ä¿ç•™è¿™ä¸€æ­¥
      uses: actions/checkout@v4

    - name: ðŸ”„ Install EPEL Repository and Utilities
      shell: bash
      run: |
        # å®‰è£… EPEL ä»“åº“é…ç½®åŒ…
        dnf install -y epel-release 
        # æ¸…ç†å¹¶é‡å»º dnf ç¼“å­˜
        dnf clean all
        dnf makecache
        # å®‰è£… tar å’Œ gzip å·¥å…·ï¼Œç”¨äºŽåŽç»­æ‰“åŒ…
        dnf install -y tar gzip git make gcc openssl-devel

    - name: ðŸ“¦ Download Build Dependencies for wrk
      shell: bash
      run: |
        echo "Starting download of build dependencies for wrk..."
        # åˆ›å»ºç›®å½•å­˜æ”¾RPMæ–‡ä»¶
        mkdir -p wrk_offline_el8
        
        # ä¸‹è½½ç¼–è¯‘ wrk æ‰€éœ€çš„ä¾èµ–åŒ…
        # wrk éœ€è¦: gcc, make, openssl-devel, git (ç”¨äºŽä¸‹è½½æºç )
        dnf download --resolve --destdir wrk_offline_el8/ gcc make openssl-devel git tar gzip
        
        # æ£€æŸ¥æ˜¯å¦ä¸‹è½½æˆåŠŸ
        if [ $? -ne 0 ]; then
          echo "ERROR: Failed to download build dependencies."
          exit 1
        fi
        
        echo "Downloaded dependency packages:"
        ls -l wrk_offline_el8/

    - name: ðŸ”¨ Build wrk from Source
      shell: bash
      run: |
        echo "Building wrk from source..."
        # å…‹éš† wrk æºç 
        git clone https://github.com/wg/wrk.git
        cd wrk
        # ç¼–è¯‘ wrk
        make
        # æ£€æŸ¥ç¼–è¯‘æ˜¯å¦æˆåŠŸ
        if [ ! -f wrk ]; then
          echo "ERROR: Failed to build wrk."
          exit 1
        fi
        # å¤åˆ¶ç¼–è¯‘å¥½çš„äºŒè¿›åˆ¶æ–‡ä»¶åˆ°ç¦»çº¿åŒ…ç›®å½•
        mkdir -p ../wrk_offline_el8/bin
        cp wrk ../wrk_offline_el8/bin/
        cd ..
        
        echo "wrk binary built successfully:"
        ls -lh wrk_offline_el8/bin/wrk

    - name: ðŸ“ Create Installation README
      shell: bash
      run: |
        cat > wrk_offline_el8/README.txt << 'EOF'
wrk ç¦»çº¿å®‰è£…åŒ… - EL8 (CentOS/Rocky 8)

å®‰è£…æ­¥éª¤ï¼š
1. å®‰è£…ä¾èµ–åŒ…ï¼š
   sudo dnf install -y *.rpm

2. å®‰è£… wrk äºŒè¿›åˆ¶æ–‡ä»¶ï¼š
   sudo cp bin/wrk /usr/local/bin/
   sudo chmod +x /usr/local/bin/wrk

3. éªŒè¯å®‰è£…ï¼š
   wrk --version

æ³¨æ„ï¼šæ­¤ç¦»çº¿åŒ…åŒ…å«ç¼–è¯‘å¥½çš„ wrk äºŒè¿›åˆ¶æ–‡ä»¶å’Œæ‰€æœ‰æž„å»ºä¾èµ–çš„ RPM åŒ…ã€‚
EOF
        echo "Created README.txt:"
        cat wrk_offline_el8/README.txt

    - name: ðŸŽ¯ Create Offline Installation Archive
      shell: bash
      run: |
        ARCHIVE_NAME="wrk-4.2.0-el8-offline-$(date +%Y%m%d).tar.gz"
        
        # åˆ‡æ¢åˆ°çˆ¶ç›®å½•æ‰“åŒ…
        tar -czvf ${ARCHIVE_NAME} wrk_offline_el8
        
        echo "::set-output name=archive_name::${ARCHIVE_NAME}"
      id: archive

    - name: â¬†ï¸ Upload Offline Package as Artifact
      uses: actions/upload-artifact@v4
      with:
        # ä½¿ç”¨ä¸Šä¸€æ­¥ç”Ÿæˆçš„æ¡£æ¡ˆåç§°
        name: ${{ steps.archive.outputs.archive_name }}
        path: ${{ steps.archive.outputs.archive_name }}
        retention-days: 7 # äº§ç‰©ä¿ç•™ 7 å¤©
        
    - name: ðŸŽ‰ Print Success Message
      run: |
        echo "--------------------------------------------------------"
        echo "ç¦»çº¿å®‰è£…åŒ…å·²æˆåŠŸæž„å»ºå¹¶ä¸Šä¼ ä¸º Artifactï¼š"
        echo "${{ steps.archive.outputs.archive_name }}"
        echo ""
        echo "å®‰è£…è¯´æ˜Žï¼š"
        echo "1. è§£åŽ‹ç¦»çº¿åŒ…: tar -xzf ${{ steps.archive.outputs.archive_name }}"
        echo "2. å®‰è£…ä¾èµ–: cd wrk_offline_el8 && sudo dnf install -y *.rpm"
        echo "3. å®‰è£… wrk: sudo cp bin/wrk /usr/local/bin/ && sudo chmod +x /usr/local/bin/wrk"
        echo "4. éªŒè¯å®‰è£…: wrk --version"
        echo "--------------------------------------------------------"